define("bundles/assess/assessmentTypes/phoenixQuiz/assessment",["require","exports","module","jquery","moment","underscore","bundles/assess/assessmentTypes/phoenixQuiz/assessment.exam.html","bundles/assess/assessmentTypes/phoenixQuiz/assessment.quiz.html","bundles/ondemand/appContextSingleton","bundles/ondemand/components/LockingCover","bundles/ondemand/components/assignments/AssignmentHonorCode","bundles/ondemand/stores/CourseScheduleStore","bundles/ondemand/stores/ProgressStore","bundles/ondemand/stores/SessionStore","bundles/ondemand/utils/assignmentVerificationTest","bundles/page/lib/metatagsAddressBook","bundles/phoenix/components/TimeDuration","bundles/phoenix/lib/view","bundles/phoenix/template/models/userAuthorization","bundles/phoenix/template/models/userIdentity","bundles/assess/components/NumberOfAttempts","js/lib/modals","js/lib/pluralize","pages/open-course/assessment/models/relativePassingStates","pages/open-course/common/utils/ensureEnrolled","pages/open-course/common/views/performanceBar","js/lib/tooltips"],function(require,exports,module){"use strict";var $=require("jquery"),l=require("moment"),_=require("underscore"),h=require("bundles/assess/assessmentTypes/phoenixQuiz/assessment.exam.html"),f=require("bundles/assess/assessmentTypes/phoenixQuiz/assessment.quiz.html"),n=require("bundles/ondemand/appContextSingleton"),C=require("bundles/ondemand/components/LockingCover"),i=require("bundles/ondemand/components/assignments/AssignmentHonorCode"),a=require("bundles/ondemand/stores/CourseScheduleStore"),I=require("bundles/ondemand/stores/ProgressStore"),s=require("bundles/ondemand/stores/SessionStore"),m=require("bundles/ondemand/utils/assignmentVerificationTest"),b=m.inHonorCodeVariant,u=require("bundles/page/lib/metatagsAddressBook"),t=require("bundles/phoenix/components/TimeDuration"),c=require("bundles/phoenix/lib/view"),p=require("bundles/phoenix/template/models/userAuthorization"),g=require("bundles/phoenix/template/models/userIdentity"),r=require("bundles/assess/components/NumberOfAttempts"),d=require("js/lib/modals"),v=require("js/lib/pluralize"),S=require("pages/open-course/assessment/models/relativePassingStates"),o=require("pages/open-course/common/utils/ensureEnrolled"),x=require("pages/open-course/common/views/performanceBar");require("js/lib/tooltips");var e=function getMetadata(e){return function(){return this.model.get("metadata").get(e)}},y=c.extend({name:"itemView",bodyClasses:"c-item-assessment",multitracker:{namespace:"open_course.item_page.quiz",baseValues:["open_course_slug","module_id","module_name","lesson_id","lesson_name","item_id","item_name"],definitions:{open_course_slug:e("course.slug"),module_id:e("lesson.module.id"),module_name:e("lesson.module.name"),lesson_id:e("lesson.id"),lesson_name:e("lesson.name"),item_id:e("id"),item_name:e("name")},events:{start:[],resume:[]},eventingVersion:2},events:{'click [data-js~="start-button"]':"start",'click [data-js~="retake-button"]':"start",'click [data-js~="review-button"]':"review",'click [data-js~="confirm-start-button"]':"confirmedStart",'click [data-js~="stay-button"]':"closeModal"},initialize:function initialize(e){$("body").addClass(this.bodyClasses),_.bindAll(this,"confirmedStart"),this.onStateChange=e.onStateChange,this.verificationDisplay=e.verificationDisplay,this.itemGrade=e.itemGrade,this.courseSlug=this.model.get("metadata.course.slug"),this.moduleNumber=this.model.get("metadata.lesson.module.index"),this.authenticated=g.get("authenticated"),this.isVerificationEnabled=this.model.get("metadata.course").isVerificationEnabled(),this.initializePerformanceBar(),this.on("view:closing",this.onClose,this),u.setMetatags({pageName:"title-and-description",context:{title:this.model.get("metadata.name"),description:this.model.get("metadata.lesson.module.description")},options:{imageHref:this.model.get("metadata.course.promoPhoto")}})},initializePerformanceBar:function initializePerformanceBar(){var e=this.model.getDisplayEvaluation(this.verificationDisplay);this.authenticated&&e&&(this.performanceBar=new x({evaluation:e,showValue:!1,disableTransitions:!0}))},onClose:function onClose(){$("body").removeClass(this.bodyClasses)},closeModal:function closeModal(){if(!this.modal)return;this.modal.close(),this.modal=null},startQuiz:function startQuiz(){"exam"===this.model.get("metadata").getTypeName()&&this.model.isLastAttemptBeforeLock()?(this.closeModal(),s.isSessionsEnabled()?this.modal=d(this.$$("last-attempt-session-modal")):this.modal=d(this.$$("last-attempt-ondemand-modal")),this.modal.open()):this.confirmedStart()},start:function start(){if(!p.ensureAuthenticated())return null;o().then(this.startQuiz.bind(this)).fail(function(e){if(!(e instanceof o.UserRejectedEnrollPromptException))throw e}).done()},confirmedStart:function confirmedStart(){this.closeModal(),this.model.hasUnsubmittedAttempt()?this.track("resume"):this.track("start");var e=this.model.get("metadata"),t=e.isPremiumGradingLocked();if("exam"===e.getTypeName()&&this.verificationDisplay.get("isProductVerificationEnabled")&&!t){var s=this.model.get("metadata.id");this.showHonorCode=b()&&!i.hasAcceptedHonorCode(s),this.showHonorCode?this.render():this.openVerificationModule()}else this.onStateChange("attempt")},openVerificationModule:function openVerificationModule(){this.onStateChange("verify")},review:function review(){this.onStateChange("attempt",{attemptIndex:this.model.getLastSubmittedAttempt()})},render:function render(){var t=f;"exam"===this.model.get("metadata").getTypeName()&&(t=h);var d=this.model.getDisplayEvaluation(this.verificationDisplay),r=this.model.getRelativePassingState(this.verificationDisplay),e={model:this.model,pluralize:v,moment:l,authenticated:this.authenticated,evaluation:d,relativePassingState:r,relativePassingStates:S,showHonorCode:this.showHonorCode};if(s.isEnrolled()){var i=this.model.get("metadata.lesson.module.id"),m=n.getComponentContext(),u=m.getStore("CourseScheduleStore"),o=u.getDeadlineForModuleId(i),c=this.model.get("bestEvaluation")&&this.model.get("bestEvaluation").getHumanPercentScore(),p=this.model.get("bestSessionId")?new Date(parseInt(this.model.get("bestSessionId").split("~")[1],10)):null;_(e).extend({enrolledInSession:!0,deadline:a.getFormattedDeadline(o),hasDeadlinePassed:l().isAfter(o),courseDeadline:a.getFormattedDeadline(s.getEndDate()),bestScore:c})}return this.$el.html(t(e)),this.renderSubviews(),this.renderRetakeButton(),this.authenticated&&this.model.hasSubmittedAttempt()&&this.model.examIsLocked&&this.model.examIsLocked()&&this.track("time_lock.render"),this},renderSubviews:function renderSubviews(){if(this.showHonorCode&&this.renderReactInto(i,"AssignmentHonorCode",{onHonorCodeAccept:this.openVerificationModule.bind(this),itemId:this.model.get("metadata.id")}),this.performanceBar&&this.$$("performance-bar-container").html(this.performanceBar.render().el),this.model.get("metadata").isLocked()&&this.renderReactInto(C,"LockingCover",{itemMetadata:this.model.get("metadata")},n.getComponentContext()),"exam"===this.model.get("metadata").getTypeName()){var e=this.model.get("metadata").getDefinition("lockingConfiguration"),a=1===e.allowedSubmissionsPerInterval,s=e.allowedSubmissionsInterval,d=this.model.get("locksIfSubmittedBefore")-Date.now(),o=a?s:d;this.renderReactIntoAll(t,"ShortIntervalDisplay",{duration:s,showNumberIfSingular:!1},void 0,!0),this.renderReactIntoAll(t,"RemainingIntervalDisplay",{duration:o,showNumberIfSingular:!1},void 0,!0),this.renderReactIntoAll(t,"RemainingIntervalFullDisplay",{duration:o,showNumberIfSingular:!0},void 0,!0);var l=e.allowedSubmissionsPerInterval;this.renderReactIntoAll(r,"NumberOfAttempts",{numberOfAttempts:l},void 0,!0)}},renderRetakeButton:function renderRetakeButton(){"exam"===this.model.get("metadata").getTypeName()&&this.$$("retake-button").attr("disabled",this.model.examIsLocked())}});module.exports=y});