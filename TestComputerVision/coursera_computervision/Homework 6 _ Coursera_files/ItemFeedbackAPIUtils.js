define("bundles/content-feedback/utils/ItemFeedbackAPIUtils",["require","exports","module","q","jsuri","underscore","bundles/content-feedback/api/myFeedbackAPI","bundles/content-feedback/api/feedbackAPI","bundles/content-feedback/api/itemFeedbackCountsAPI","bundles/content-feedback/api/itemFeedbackCommentCountsAPI","bundles/content-feedback/api/feedbackAdminAPI","bundles/content-feedback/utils/ItemFeedbackUtils","bundles/content-feedback/models/FlagFeedback","bundles/content-feedback/constants/FeedbackTypes"],function(require,exports,module){"use strict";var e=require("q"),a=require("jsuri"),_=require("underscore"),i=require("bundles/content-feedback/api/myFeedbackAPI"),k=require("bundles/content-feedback/api/feedbackAPI"),P=require("bundles/content-feedback/api/itemFeedbackCountsAPI"),s=require("bundles/content-feedback/api/itemFeedbackCommentCountsAPI"),u=require("bundles/content-feedback/api/feedbackAdminAPI"),m=require("bundles/content-feedback/utils/ItemFeedbackUtils"),y=require("bundles/content-feedback/models/FlagFeedback"),d=y.statuses,c=d.UNRESOLVED,r=d.TODO,b=d.RESOLVED,l=d.ARCHIVED,o=require("bundles/content-feedback/constants/FeedbackTypes"),n=o.Like,t=o.Flag,f={getFeedbackCount:function getFeedbackCount(r,u,c,d,n,o){var t=(new a).addQueryParam("q","course").addQueryParam("courseId",r).addQueryParam("feedbackSystem",u).addQueryParam("ratingValues",c).addQueryParam("countBy","itemId");if(d&&t.addQueryParam("categories",d),n&&t.addQueryParam("statuses",n),o)return e(s.get(t.toString()));return e(P.get(t.toString()))},get:function get(a){var u=m.getVisibleFlagCategories(),d=_(u).pluck("id").join(","),s=this.getFeedbackCount(a,n,0),o=this.getFeedbackCount(a,n,1),i=this.getFeedbackCount(a,t,0,d,c,!0),b=this.getFeedbackCount(a,t,0,d,r,!0);return e.all([s,o,i,b]).spread(function(t,d,n,r){var a={likes:d.elements[0].counts,dislikes:t.elements[0].counts,todoFlags:r.elements[0].counts,unresolvedFlags:n.elements[0].counts},e={};return _(a).each(function(a,t){_(a).each(function(d,a){e[a]||(e[a]={}),e[a][t]=d})}),_(e).each(function(d,t){_(a).each(function(d,a){e[t][a]||(e[t][a]=0)})}),e})},getFlagFeedbacks:function getFlagFeedbacks(u,c,s,r,d){var o=d?"subItem":"item",n=(new a).addQueryParam("q",o).addQueryParam("courseId",u).addQueryParam("itemId",c).addQueryParam("feedbackSystem",t).addQueryParam("ratingValues",0).addQueryParam("page",0).addQueryParam("limit",100).addQueryParam("categories",s.id).addQueryParam("fields","debugInfo, categoryStates");return r&&n.addQueryParam("statuses",r),d&&n.addQueryParam("subItemId",d),e(k.get(n.toString())).then(function(e){var a=e.elements,t=e.paging,d=t.total;return{feedbacks:a,totalCount:d}})},getFlagFeedbackCounts:function getFlagFeedbackCounts(d,n,u){var o=(new a).addQueryParam("q","items").addQueryParam("courseId",d).addQueryParam("itemIds",n).addQueryParam("feedbackSystem",t).addQueryParam("ratingValues",0).addQueryParam("statuses",[c,r,b,l].join(",")).addQueryParam("categories",u.id).addQueryParam("countBy","status");return e(s.get(o.toString())).then(function(e){return e.elements[0].counts})},updateFeedbackStatus:function updateFeedbackStatus(t,d,n){var r=(new a).addQueryParam("status",n).addQueryParam("action","updateStatus").addQueryParam("category",d.id);return e(u.post(r.toString(),{data:t}))},deleteFeedback:function deleteFeedback(t,d){var n=t.map(function(t){var n=(new a).addQueryParam("action","hide").addQueryParam("feedbackId",t).addQueryParam("category",d.id);return e(u.post(n.toString()))});return e.all(n)},getMyAll:function getMyAll(n,r,t){var u=t?"subItem":"item",d=(new a).addQueryParam("q",u).addQueryParam("courseId",n).addQueryParam("itemId",r);return t&&d.addQueryParam("genericSubItemId",t),e(i.get(d.toString())).then(function(e){return e.elements})},postMyFeedback:function postMyFeedback(n,r,u,c,t){var d=(new a).addQueryParam("action","submit").addQueryParam("courseId",n).addQueryParam("itemId",r).addQueryParam("feedbackSystem",u);return t&&d.addQueryParam("genericSubItemId",t),e(i.post(d.toString(),{data:c.toObject()}))},postMyLike:function postMyLike(e,a,t,d){return this.postMyFeedback(e,a,n,t,d)},postMyFlag:function postMyFlag(e,a,d,n){return this.postMyFeedback(e,a,t,d,n)}};module.exports=f});