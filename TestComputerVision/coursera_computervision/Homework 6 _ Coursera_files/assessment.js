define("bundles/assess/assessmentTypes/phoenixQuiz/assessment",["require","exports","module","jquery","moment","underscore","bundles/assess/assessmentTypes/phoenixQuiz/assessment.exam.html","bundles/assess/assessmentTypes/phoenixQuiz/assessment.quiz.html","bundles/ondemand/appContextSingleton","bundles/ondemand/components/LockingCover","bundles/ondemand/components/assignments/AssignmentHonorCode","bundles/ondemand/utils/assignmentVerificationTest","bundles/page/lib/metatagsAddressBook","bundles/phoenix/components/TimeDuration","bundles/phoenix/lib/view","bundles/phoenix/template/models/userAuthorization","bundles/phoenix/template/models/userIdentity","bundles/assess/components/NumberOfAttempts","bundles/ondemand/utils/deadlineFormatter","js/lib/modals","js/lib/pluralize","pages/open-course/assessment/models/relativePassingStates","pages/open-course/common/utils/ensureEnrolled","pages/open-course/common/views/performanceBar","js/lib/tooltips"],function(require,exports,module){"use strict";var $=require("jquery"),n=require("moment"),_=require("underscore"),u=require("bundles/assess/assessmentTypes/phoenixQuiz/assessment.exam.html"),g=require("bundles/assess/assessmentTypes/phoenixQuiz/assessment.quiz.html"),t=require("bundles/ondemand/appContextSingleton"),p=require("bundles/ondemand/components/LockingCover"),i=require("bundles/ondemand/components/assignments/AssignmentHonorCode"),v=require("bundles/ondemand/utils/assignmentVerificationTest"),C=v.inHonorCodeVariant,l=require("bundles/page/lib/metatagsAddressBook"),s=require("bundles/phoenix/components/TimeDuration"),r=require("bundles/phoenix/lib/view"),x=require("bundles/phoenix/template/models/userAuthorization"),h=require("bundles/phoenix/template/models/userIdentity"),c=require("bundles/assess/components/NumberOfAttempts"),o=require("bundles/ondemand/utils/deadlineFormatter"),a=require("js/lib/modals"),b=require("js/lib/pluralize"),f=require("pages/open-course/assessment/models/relativePassingStates"),d=require("pages/open-course/common/utils/ensureEnrolled"),S=require("pages/open-course/common/views/performanceBar");require("js/lib/tooltips");var e=function getMetadata(e){return function(){return this.model.get("metadata").get(e)}},m=r.extend({name:"itemView",bodyClasses:"c-item-assessment",multitracker:{namespace:"open_course.item_page.quiz",baseValues:["open_course_slug","module_id","module_name","lesson_id","lesson_name","item_id","item_name"],definitions:{open_course_slug:e("course.slug"),module_id:e("lesson.module.id"),module_name:e("lesson.module.name"),lesson_id:e("lesson.id"),lesson_name:e("lesson.name"),item_id:e("id"),item_name:e("name")},events:{start:[],resume:[]},eventingVersion:2},events:{'click [data-js~="start-button"]':"start",'click [data-js~="retake-button"]':"start",'click [data-js~="review-button"]':"review",'click [data-js~="confirm-start-button"]':"confirmedStart",'click [data-js~="stay-button"]':"closeModal"},initialize:function initialize(e){$("body").addClass(this.bodyClasses),_.bindAll(this,"confirmedStart"),this.onStateChange=e.onStateChange,this.verificationDisplay=e.verificationDisplay,this.itemGrade=e.itemGrade,this.courseSlug=this.model.get("metadata.course.slug"),this.moduleNumber=this.model.get("metadata.lesson.module.index"),this.authenticated=h.get("authenticated"),this.isVerificationEnabled=this.model.get("metadata.course").isVerificationEnabled(),this.initializePerformanceBar(),this.on("view:closing",this.onClose,this),l.setMetatags({pageName:"title-and-description",context:{title:this.model.get("metadata.name"),description:this.model.get("metadata.lesson.module.description")},options:{imageHref:this.model.get("metadata.course.promoPhoto")}})},initializePerformanceBar:function initializePerformanceBar(){var e=this.model.getDisplayEvaluation(this.verificationDisplay);this.authenticated&&e&&(this.performanceBar=new S({evaluation:e,showValue:!1,disableTransitions:!0}))},onClose:function onClose(){$("body").removeClass(this.bodyClasses)},closeModal:function closeModal(){if(!this.modal)return;this.modal.close(),this.modal=null},startQuiz:function startQuiz(){if("exam"===this.model.get("metadata").getTypeName()&&this.model.isLastAttemptBeforeLock()){this.closeModal();var e=t.getComponentContext().getStore("SessionStore");e.isSessionsEnabled()?this.modal=a(this.$$("last-attempt-session-modal")):this.modal=a(this.$$("last-attempt-ondemand-modal")),this.modal.open()}else this.confirmedStart()},start:function start(){if(!x.ensureAuthenticated())return null;d().then(this.startQuiz.bind(this)).fail(function(e){if(!(e instanceof d.UserRejectedEnrollPromptException))throw e}).done()},confirmedStart:function confirmedStart(){this.closeModal(),this.model.hasUnsubmittedAttempt()?this.track("resume"):this.track("start");var e=this.model.get("metadata"),s=e.isPremiumGradingLocked(),n=t.getComponentContext().getStore("SessionStore");if("exam"===e.getTypeName()&&this.verificationDisplay.get("isProductVerificationEnabled")&&!s){var o=this.model.get("metadata.id");this.showHonorCode=C(n.getSessionId())&&!i.hasAcceptedHonorCode(o),this.showHonorCode?this.render():this.openVerificationModule()}else this.onStateChange("attempt")},openVerificationModule:function openVerificationModule(){this.onStateChange("verify")},review:function review(){this.onStateChange("attempt",{attemptIndex:this.model.getLastSubmittedAttempt()})},render:function render(){var i=t.getComponentContext(),e=i.getStore("SessionStore"),s=g;"exam"===this.model.get("metadata").getTypeName()&&(s=u);var m=this.model.getDisplayEvaluation(this.verificationDisplay),l=this.model.getRelativePassingState(this.verificationDisplay),a={model:this.model,pluralize:b,moment:n,authenticated:this.authenticated,evaluation:m,relativePassingState:l,relativePassingStates:f,showHonorCode:this.showHonorCode,isItemLocked:e.isItemLocked(this.model.get("metadata"))};if(e.isEnrolled()){var r=this.model.get("metadata.lesson.module.id"),h=i.getStore("CourseScheduleStore"),d=h.getDeadlineForModuleId(r),c=this.model.get("bestEvaluation")&&this.model.get("bestEvaluation").getHumanPercentScore();_(a).extend({enrolledInSession:!0,deadline:o.getFormattedDeadline(d),hasDeadlinePassed:n().isAfter(d),courseDeadline:o.getFormattedDeadline(e.getEndDate()),bestScore:c})}return this.$el.html(s(a)),this.renderSubviews(),this.renderRetakeButton(),this.authenticated&&this.model.hasSubmittedAttempt()&&this.model.examIsLocked&&this.model.examIsLocked()&&this.track("time_lock.render"),this},renderSubviews:function renderSubviews(){this.showHonorCode&&this.renderReactInto(i,"AssignmentHonorCode",{onHonorCodeAccept:this.openVerificationModule.bind(this),itemId:this.model.get("metadata.id")}),this.performanceBar&&this.$$("performance-bar-container").html(this.performanceBar.render().el);var a=t.getComponentContext().getStore("SessionStore"),d=a.isItemLocked(this.model.get("metadata"));if(d&&this.renderReactInto(p,"LockingCover",{itemMetadata:this.model.get("metadata")},t.getComponentContext()),"exam"===this.model.get("metadata").getTypeName()){var e=this.model.get("metadata").getDefinition("lockingConfiguration"),l=1===e.allowedSubmissionsPerInterval,n=e.allowedSubmissionsInterval,m=this.model.get("locksIfSubmittedBefore")-Date.now(),o=l?n:m;this.renderReactIntoAll(s,"ShortIntervalDisplay",{duration:n,showNumberIfSingular:!1},void 0,!0),this.renderReactIntoAll(s,"RemainingIntervalDisplay",{duration:o,showNumberIfSingular:!1},void 0,!0),this.renderReactIntoAll(s,"RemainingIntervalFullDisplay",{duration:o,showNumberIfSingular:!0},void 0,!0);var r=e.allowedSubmissionsPerInterval;this.renderReactIntoAll(c,"NumberOfAttempts",{numberOfAttempts:r},void 0,!0)}},renderRetakeButton:function renderRetakeButton(){"exam"===this.model.get("metadata").getTypeName()&&this.$$("retake-button").attr("disabled",this.model.examIsLocked())}});module.exports=m});