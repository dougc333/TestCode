define("bundles/verification/views/profileSetup",["require","exports","module","underscore","bundles/phoenix/lib/view","bundles/phoenix/template/models/userVerification","bundles/verification/views/profileSetup.html","js/app/config","js/lib/jquery.phoenixWebcam","js/lib/keystrokeAuthenticator","pages/open-course/common/constants","bundles/verification/data/api","js/lib/jquery.keytracrecorder","css!bundles/verification/styl/index.css"],function(require,exports,module){"use strict";var _=require("underscore"),s=require("bundles/phoenix/lib/view"),t=require("bundles/phoenix/template/models/userVerification"),o=require("bundles/verification/views/profileSetup.html"),a=require("js/app/config"),r=require("js/lib/jquery.phoenixWebcam"),n=require("js/lib/keystrokeAuthenticator"),e=require("pages/open-course/common/constants").signatureTrack,i=require("bundles/verification/data/api");require("js/lib/jquery.keytracrecorder"),require("css!bundles/verification/styl/index.css");var c=s.extend({template:o,stateModelProperty:"model",templateOptions:function templateOptions(){return{config:a,keystrokeAuthPhrase:this.keystrokeAuthenticator.authPhrase,completedKeystrokes:t.completedKeystrokes(),isVerifyingAssessment:this.isVerifyingAssessment,canOptOut:this.verificationViewModel.get("canOptOut")}},events:{'click [data-js~="goto-setup-info"]':"showVerifiedSetupInfo",'click [data-js~="start-verified-setup"]':"startVerifiedSetup",'click [data-js~="skip-verified-setup"]':"onCancelProfileSetup",'click [data-js~="cancel-profile-setup-confirm"]':"onCancelProfileSetupConfirm",'keyup [data-js~="keystroke-auth-input-1"]':"onEveryKeystroke",'focus [data-js~="keystroke-auth-input-2"]':"onKeystrokeInput2Focus",'keyup [data-js~="keystroke-auth-input-2"]':"onEveryKeystroke",'click [data-js~="submit-keystrokes"]':"submitKeystrokes",'click [data-js~="expand-webcam-help"]':"expandWebcamHelp",'click [data-js~="shrink-webcam-help"]':"shrinkWebcamHelp",'click [data-js~="retake-photo"]':"retakePhoto",'click [data-js~="switch-webcam-driver"]':"toggleWebcamDriver",'click [data-js~="take-photo-button"]':"takePhoto",'click [data-js~="submit-photo"]':"onSubmitPhoto",'click [data-js~="complete-profile-setup"]':"onCompleteProfileSetup"},multitracker:{namespace:"verification.profile_setup",baseValues:["course_id","module_id","lesson_id","item_id"],definitions:{course_id:function course_id(){return this.verificationViewModel.metadata?this.verificationViewModel.metadata.get("course.id"):""},module_id:function module_id(){return this.verificationViewModel.metadata?this.verificationViewModel.metadata.get("lesson.module.id"):""},lesson_id:function lesson_id(){return this.verificationViewModel.metadata?this.verificationViewModel.metadata.get("lesson.id"):""},item_id:function item_id(){return this.verificationViewModel.metadata?this.verificationViewModel.metadata.get("id"):""},step:function step(){return this.getEventingStep()}},events:{"click.verification_learn_more":{values:["step"],delegate:'click [data-js~="verification-info-link"]'},"click.camera_troubleshoot":'click [data-js~="help-center"]'},eventingVersion:2},webcamOptions:{swfFile:e.swfFile,constraintImgHalf:e.webcamConstraintImage,constraintImgWidthPercent:e.webcamConstraintImageWidthPercent,constraintImgMarginPercent:e.webcamConstraintImageMarginPercent},initialize:function initialize(e){_.bindAll(this,"onKeystrokePattern1","onEveryKeystroke","checkIfCompletedPhrase","onKeystrokeRegisterSuccess","onKeystrokeRegisterError","onNewWebcamCreated","onCameraEnabled","onCameraDisabled","onSwfApiFail","onWebcamError","onCameraDestroy","onTakePhotoSuccess","onWebcamSubmitSuccess","onWebcamSubmitError"),this.model=e.profileSetupViewModel,this.verificationViewModel=e.verificationViewModel,this.isProfileComplete=e.isProfileComplete,this.isVerifyingAssessment=e.isVerifyingAssessment,this.keystrokeAuthenticator=new n,this.keystrokePhraseLength=this.keystrokeAuthenticator.authPhrase.length,this.initializeEvents(),this.keytracData={removeEditability:!0,golden:this.keystrokeAuthenticator.authPhrase}},initializeEvents:function initializeEvents(){this.listenTo(this.model,"change:state",this.onStateChange),this.listenTo(this.model,"state:enter:keystroke-pattern1",this.onKeystrokePattern1),this.listenTo(this.model,"state:enter:keystroke-pattern2",this.onKeystrokePattern2),this.listenTo(this.model,"state:enter:transitioning-to-webcam",this.onTransitioningToWebcam),this.listenTo(this.model,"state:enter:webcam-ready",this.initializeWebcam),this.listenTo(this.model,"destroy",this.destroy)},destroy:function destroy(){this.destroyKeystrokeRecorders(),this.destroyWebcamInstance(),this.region.close()},postRender:function postRender(){this.track("render"),this.isProfileComplete&&this.model.transition("webcam-submit-success")},showVerifiedSetupInfo:function showVerifiedSetupInfo(){this.track("click.first_verify_prompt"),this.model.transition("setup-info")},startVerifiedSetup:function startVerifiedSetup(){this.track("click.setup_profile"),t.completedKeystrokes()?this.model.transition("webcam-ready"):this.model.transition("keystroke-pattern1")},onCancelProfileSetup:function onCancelProfileSetup(){var e=void 0,t=void 0;this.$$("skip-setup-block").is(":visible")?(e="expanded",t="collapsed"):(e="collapsed",t="expanded"),this.track("click.cancel_profile_setup",{step:this.getEventingStep(),status_before_click:e,status_after_click:t}),this.$$("skip-setup-block").slideToggle()},onCancelProfileSetupConfirm:function onCancelProfileSetupConfirm(){this.destroyKeystrokeRecorders(),this.destroyWebcamInstance(),this.$$("cancel-profile-setup-confirm").prop("disabled",!0),this.track("click.cancel_profile_setup_confirm",{step:this.getEventingStep()}),this.verificationViewModel.trigger("verificationComplete",{hasVerified:!1})},getEventingStep:function getEventingStep(){var e="";return this.model.isState("setup-info")?e="initial":this.model.isState("keystroke-pattern1")||this.model.isState("keystroke-pattern1-wrong")||this.model.isState("keystroke-pattern2")||this.model.isState("keystroke-pattern2-wrong")?e="typing_pattern":this.model.isState("webcam-ready")?e="take_photo":this.model.isState("webcam-took-photo")&&(e="use_photo"),e},destroyKeystrokeRecorders:function destroyKeystrokeRecorders(){this.model.get("hasKeytracRecorder1")&&(this.$$("keystroke-auth-input-1").keytracRecorder("removeListener"),this.model.set("hasKeytracRecorder1",!1)),this.model.get("hasKeytracRecorder2")&&(this.$$("keystroke-auth-input-2").keytracRecorder("removeListener"),this.model.set("hasKeytracRecorder2",!1))},destroyWebcamInstance:function destroyWebcamInstance(){this.webcamInstance&&this.webcamInstance.destroy()},onStateChange:function onStateChange(){this.$$("error-messages").hide(),this.$$("skip-setup-block").hide(),this.renderState()},onKeystrokePattern1:function onKeystrokePattern1(){this.model.get("hasKeytracRecorder1")||(this.$$("keystroke-auth-input-1").keytracRecorder(),this.model.set("hasKeytracRecorder1",!0))},onEveryKeystroke:function onEveryKeystroke(){var e=void 0,t=void 0;this.model.isState("keystroke-pattern1")||this.model.isState("keystroke-pattern1-wrong")?(e=this.$$("keystroke-auth-input-1").val(),t=this.$$("keystroke-auth-bar-1")):(this.model.isState("keystroke-pattern2")||this.model.isState("keystroke-pattern2-wrong"))&&(e=this.$$("keystroke-auth-input-2").val(),t=this.$$("keystroke-auth-bar-2")),this.updateProgressBar(e,t),this.checkTypedPhraseAndTransition(e)},updateProgressBar:function updateProgressBar(e,t){var i=e.length,s=Math.min(100,i/this.keystrokePhraseLength*100);t.css("width",s+"%")},checkTypedPhraseAndTransition:function checkTypedPhraseAndTransition(e){var t=this.keystrokeAuthenticator.isCorrectAuthPhraseSoFar(e);t?(this.model.isState("keystroke-pattern1-wrong")?this.model.transition("keystroke-pattern1"):this.model.isState("keystroke-pattern2-wrong")&&this.model.transition("keystroke-pattern2"),(this.model.isState("keystroke-pattern1")||this.model.isState("keystroke-pattern2"))&&this.checkIfCompletedPhrase(e)):this.model.isState("keystroke-pattern1")?this.model.transition("keystroke-pattern1-wrong"):this.model.isState("keystroke-pattern2")&&this.model.transition("keystroke-pattern2-wrong")},checkIfCompletedPhrase:function checkIfCompletedPhrase(t){var i=this.keystrokeAuthenticator.isCorrectAuthPhrase(t)&&this.keystrokeAuthenticator.hasCompletedAuthPhrase(t,e.keystroke.errorAllowedPrefix,e.keystroke.errorAllowedSuffix);i?this.model.isState("keystroke-pattern1")?(this.$$("keystroke1-complete-message").show(),this.$$("keystroke-auth-input-2").prop("disabled",!1)):this.model.isState("keystroke-pattern2")&&this.$$("submit-keystrokes").prop("disabled",!1):this.model.isState("keystroke-pattern1")?(this.$$("keystroke1-complete-message").hide(),this.$$("keystroke-auth-input-2").prop("disabled",!0)):this.model.isState("keystroke-pattern2")&&this.$$("submit-keystrokes").prop("disabled",!0)},onKeystrokeInput2Focus:function onKeystrokeInput2Focus(){if(this.model.isState("keystroke-pattern1")){var e=this.$$("keystroke-auth-input-1");e.prop("disabled",!0),this.keytracData.text1=e.val(),this.keytracData.keytrac1=e.keytracRecorder("keystroke"),this.destroyKeystrokeRecorders(),this.$$("keystroke1-complete-message").hide(),this.track("emit.first_typing_pattern_complete"),this.model.transition("keystroke-pattern2")}},onKeystrokePattern2:function onKeystrokePattern2(){this.model.get("hasKeytracRecorder2")||(this.$$("keystroke-auth-input-2").keytracRecorder(),this.model.set("hasKeytracRecorder2",!0))},submitKeystrokes:function submitKeystrokes(){this.$$("submit-keystrokes").prop("disabled",!0);var t=this.$$("keystroke-auth-input-2");t.prop("disabled",!0),this.keytracData.text2=t.val(),this.keytracData.keytrac2=t.keytracRecorder("keystroke"),this.destroyKeystrokeRecorders(),this.track("click.match_patterns"),this.model.transition("keystroke-submitting"),_.delay(function(){i.registerKeystrokes(this.keytracData).then(this.onKeystrokeRegisterSuccess,this.onKeystrokeRegisterError).fin(this.onKeystrokesSubmitComplete).done()}.bind(this),e.verificationSubmitDelay)},onKeystrokesSubmitComplete:function onKeystrokesSubmitComplete(){},onKeystrokeRegisterSuccess:function onKeystrokeRegisterSuccess(){this.track("emit.successful_match"),this.model.transition("transitioning-to-webcam"),t.updateKeystrokesVerified(!0)},onKeystrokeRegisterError:function onKeystrokeRegisterError(){this.track("emit.failed_match"),this.$$("keystroke-auth-input-1").val("").prop("disabled",!1),this.updateProgressBar("",this.$$("keystroke-auth-bar-1")),this.$$("keystroke-auth-input-2").val(""),this.updateProgressBar("",this.$$("keystroke-auth-bar-2")),this.model.transition("keystroke-pattern1"),this.$$("keystrokes-match-error").slideDown("fast")},initializeWebcam:function initializeWebcam(e){this.webcamInstance=new r(this.$$("webcam-container"));var t={newWebcamCallback:this.onNewWebcamCreated,cameraEnabledCallback:this.onCameraEnabled,cameraDisabledCallback:this.onCameraDisabled,noCameraFoundCallback:this.onCameraDisabled,swfApiFailCallback:this.onSwfApiFail,error:this.onWebcamError,destroyCameraCallback:this.onCameraDestroy};this.webcamInstance.initialize(_.extend({},this.webcamOptions,t,e))},onTransitioningToWebcam:function onTransitioningToWebcam(){_.delay(function(){this.model.transitionIfNot("webcam-ready")}.bind(this),e.transitionToWebcamDuration)},onNewWebcamCreated:function onNewWebcamCreated(){this.webcamInstance.isHTML5Supported()?(this.$$("html5-webcam-help-image").attr("src",this.getHTML5WebcamHelpImage()),this.$$("switch-to-html5-webcam-link").show()):this.$$("switch-to-html5-webcam-link").hide(),this.webcamInstance.isUsingHTML5()?(this.$$("html5-webcam-allow-text").show(),this.$$("flash-webcam-allow-text").hide(),this.$$("html5-webcam-help-image-container").show(),navigator.mozGetUserMedia?(this.$$("moz-webcam-help-text").show(),this.$$("chrome-webcam-help-text").hide()):(this.$$("moz-webcam-help-text").hide(),this.$$("chrome-webcam-help-text").show())):(this.$$("flash-webcam-allow-text").show(),this.$$("html5-webcam-allow-text").hide(),this.$$("html5-webcam-help-image-container").hide())},onCameraEnabled:function onCameraEnabled(){this.track("emit.camera_enabled"),this.$$("html5-webcam-allow-text").hide(),this.$$("flash-webcam-allow-text").hide(),this.$$("take-photo-button").prop("disabled",!1),this.shrinkWebcamHelp()},onCameraDisabled:function onCameraDisabled(){this.$$("take-photo-button").prop("disabled",!0)},onSwfApiFail:function onSwfApiFail(){this.onWebcamError("Flash webcam error: swf API failure.")},onWebcamError:function onWebcamError(e){this.$$("error-messages").hide(),this.$$("webcam-error").val(e),this.$$("webcam-error").slideDown("fast")},onCameraDestroy:function onCameraDestroy(){this.$$("take-photo-button").prop("disabled",!0)},toggleWebcamDriver:function toggleWebcamDriver(){this.webcamInstance.isHTML5Supported()&&(this.shrinkWebcamHelp(),this.webcamInstance.isUsingHTML5()?this.track("click.switch_to_flash"):this.track("click.switch_to_html5"),this.webcamInstance.toggleDriver())},expandWebcamHelp:function expandWebcamHelp(){this.track("click.help_camera",{status_before_click:"collapsed",status_after_click:"expanded"}),this.$$("expand-webcam-help").attr("data-js","shrink-webcam-help"),this.webcamInstance.isUsingHTML5()?this.$$("webcam-help-instructions-html5").slideDown():this.$$("webcam-help-instructions-flash").slideDown()},shrinkWebcamHelp:function shrinkWebcamHelp(){this.track("click.help_camera",{status_before_click:"expanded",status_after_click:"collapsed"}),this.$$("shrink-webcam-help").attr("data-js","expand-webcam-help"),this.$$("webcam-help-instructions-html5").slideUp(),this.$$("webcam-help-instructions-flash").slideUp()},getHTML5WebcamHelpImage:function getHTML5WebcamHelpImage(){return navigator.mozGetUserMedia?e.firefoxWebcamHelpImage:e.chromeWebcamHelpImage},takePhoto:function takePhoto(e){e.preventDefault(),this.shrinkWebcamHelp(),this.track("click.take_photo"),this.webcamInstance.takePhoto(this.onTakePhotoSuccess)},onTakePhotoSuccess:function onTakePhotoSuccess(e){this.track("emit.photo_taken"),this.imageData=e,this.model.transition("webcam-took-photo"),this.$$("take-photo-button").prop("disabled",!0),this.$$("submit-photo").prop("disabled",!1)},retakePhoto:function retakePhoto(){this.destroyWebcamInstance(),this.track("click.retake_photo"),this.model.transition("webcam-ready")},onSubmitPhoto:function onSubmitPhoto(){var t=this.model.incrementWebcamAttemptCount();this.$$("submit-photo").prop("disabled",!0),this.track("click.use_photo"),this.model.transition("webcam-submitting"),_.delay(function(){var e={type:"face",attemptCount:t,photo:this.imageData};i.registerFacePhoto(e).then(this.onWebcamSubmitSuccess,this.onWebcamSubmitError).fin(this.onWebcamSubmitComplete).done()}.bind(this),e.verificationSubmitDelay)},onWebcamSubmitComplete:function onWebcamSubmitComplete(){},onWebcamSubmitSuccess:function onWebcamSubmitSuccess(e){this.track("emit.photo_submission_success"),t.updatePhotoFace(!0),this.destroyWebcamInstance(),this.model.transition("webcam-submit-success"),this.verificationViewModel.set("verifiableId",e.verifiableId),this.isVerifyingAssessment||this.verificationViewModel.trigger("verificationComplete",{hasVerified:!0})},onWebcamSubmitError:function onWebcamSubmitError(){this.track("emit.photo_submission_failed"),this.destroyWebcamInstance(),this.model.transition("webcam-ready"),this.$$("webcam-submit-error").slideDown("fast")},onCompleteProfileSetup:function onCompleteProfileSetup(){this.$$("complete-profile-setup").prop("disabled",!0),this.track("click.profile_setup_complete"),this.verificationViewModel.trigger("verificationComplete",{hasVerified:!0})}});module.exports=c});