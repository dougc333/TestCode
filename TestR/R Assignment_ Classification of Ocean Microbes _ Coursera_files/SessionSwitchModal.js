define("bundles/ondemand/components/sessions/SessionSwitchModal",["require","exports","module","react-with-addons","i18n!nls/ondemand","underscore","vendor/cnpm/fluxible.v0-4/addons/FluxibleComponent","bundles/phoenix/template/models/userIdentity","naptime","js/lib/mapProps","js/lib/setupFluxibleApp","js/lib/waitFor","bundles/naptimejs/stores/NaptimeStore","bundles/ssr/stores/ApplicationStore","bundles/naptimejs/resources/onDemandLearnerSessions.v1","bundles/naptimejs/resources/courses.v1","bundles/phoenix/components/Modal","bundles/ondemand/components/sessions/SessionSwitchInfo","bundles/ondemand/components/sessions/SessionSwitchBranchChangeInfo","bundles/ondemand/components/sessions/SessionSwitchSuccess","bundles/ondemand/utils/onDemandSessionsApi","css!./__styles__/SessionSwitchModal.css"],function(require,exports,module){"use strict";function _defaults(e,t){for(var r=Object.getOwnPropertyNames(t),n=0;n<r.length;n++){var s=r[n],o=Object.getOwnPropertyDescriptor(t,s);o&&o.configurable&&void 0===e[s]&&Object.defineProperty(e,s,o)}return e}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _inherits(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(n,e):_defaults(n,e))}var n=function(){function defineProperties(o,s){for(var n=0;n<s.length;n++){var e=s[n];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(o,e.key,e)}}return function(e,n,s){return n&&defineProperties(e.prototype,n),s&&defineProperties(e,s),e}}(),o=function get(r,c,a){var s=!0;e:for(;s;){var n=r,i=c,l=a;s=!1,null===n&&(n=Function.prototype);var e=Object.getOwnPropertyDescriptor(n,i);if(void 0===e){var o=Object.getPrototypeOf(n);if(null===o)return void 0;r=o,c=i,a=l,s=!0,e=o=void 0;continue e}if("value"in e)return e.value;var t=e.get;if(void 0===t)return void 0;return t.call(l)}},e=require("react-with-addons"),h=require("i18n!nls/ondemand"),y=require("underscore"),i=y.compose,l=require("vendor/cnpm/fluxible.v0-4/addons/FluxibleComponent"),c=require("bundles/phoenix/template/models/userIdentity"),a=require("naptime"),u=require("js/lib/mapProps"),r=require("js/lib/setupFluxibleApp"),d=require("js/lib/waitFor"),p=require("bundles/naptimejs/stores/NaptimeStore"),m=require("bundles/ssr/stores/ApplicationStore"),s=require("bundles/naptimejs/resources/onDemandLearnerSessions.v1"),f=require("bundles/naptimejs/resources/courses.v1"),b=require("bundles/phoenix/components/Modal"),S=require("bundles/ondemand/components/sessions/SessionSwitchInfo"),v=require("bundles/ondemand/components/sessions/SessionSwitchBranchChangeInfo"),w=require("bundles/ondemand/components/sessions/SessionSwitchSuccess"),t=require("bundles/ondemand/utils/onDemandSessionsApi");require("css!./__styles__/SessionSwitchModal.css");var g=function(r){function SessionSwitchModal(n,s){var e=this;_classCallCheck(this,SessionSwitchModal),o(Object.getPrototypeOf(SessionSwitchModal.prototype),"constructor",this).call(this,n,s),this.handleSessionSwitch=function(n){e.props.activeNotEnrollableSession?t.unenroll(e.props.activeNotEnrollableSession.sessionId).then(function(){return e.enrollInSession(n)}):e.enrollInSession(n)},this.showChangesDescription=function(n){e.setState({showBranchChangesInfo:!0,showSuccess:!1,sessionToJoin:n})},this.enrollInSession=function(n){t.enroll(n.sessionId).then(function(){e.setState({showBranchChangesInfo:!1,showSuccess:!0,enrolledSession:n})}).done()},this.state={showBranchChangesInfo:!1,showSuccess:!1}}return _inherits(SessionSwitchModal,r),n(SessionSwitchModal,null,[{key:"propTypes",value:{onClose:e.PropTypes.func.isRequired,courseId:e.PropTypes.string.isRequired,courseHomeLink:e.PropTypes.string.isRequired,upcomingEnrollableSessions:e.PropTypes.arrayOf(s).isRequired,activeNotEnrollableSession:e.PropTypes.instanceOf(s)},enumerable:!0}]),n(SessionSwitchModal,[{key:"render",value:function render(){var s=this.props,l=s.courseHomeLink,c=s.onClose,r=s.upcomingEnrollableSessions,n=this.state,o=n.showBranchChangesInfo,t=n.showSuccess,a=n.sessionToJoin,u=n.enrolledSession,i=!o&&!t;return e.createElement("div",{className:"rc-SessionSwitchModal"},e.createElement(b,{handleClose:c,modalName:h("Join a new session")},i&&e.createElement(S,{upcomingEnrollableSessions:r,showChangesDescription:this.showChangesDescription,handleSessionSwitch:this.handleSessionSwitch}),o&&e.createElement(v,{sessionToJoin:a,handleSessionSwitch:this.handleSessionSwitch}),t&&e.createElement(w,{courseHomeLink:l,enrolledSession:u})))}}]),SessionSwitchModal}(e.Component),x=i(a.createContainer(function(e){return{learnerSessions:s.finder("activeAndUpcoming",{params:{courseId:e.courseId,learnerId:c.get("id"),limit:4},fields:["startsAt","endsAt","enrollmentEndsAt","enrollmentStartsAt","isActiveEnrollment","isEnrollableNow","sessionSwitch","isEnrolled"]}),course:f.get(e.courseId,{params:{showHidden:!0}})}}),d(function(e,n){return!!e.learnerSessions&&!!e.course}),u(function(e){return{upcomingEnrollableSessions:e.learnerSessions.filter(function(e){return!e.enrollmentEnded}).slice(0,3),activeNotEnrollableSession:e.learnerSessions.find(function(e){return e.isActiveEnrollment&&e.enrollmentEnded}),courseHomeLink:e.course.phoenixHomeLink}}))(g),j=function setupApp(e){return r(e,function(n){return n.registerStore(p),n.registerStore(m),e})};module.exports=function(s){function FluxifiedSessionSwitchModal(n,e){_classCallCheck(this,FluxifiedSessionSwitchModal),o(Object.getPrototypeOf(FluxifiedSessionSwitchModal.prototype),"constructor",this).call(this,n,e),this.fluxibleContext=j(e.fluxibleContext)}return _inherits(FluxifiedSessionSwitchModal,s),n(FluxifiedSessionSwitchModal,null,[{key:"contextTypes",value:{fluxibleContext:e.PropTypes.object},enumerable:!0}]),n(FluxifiedSessionSwitchModal,[{key:"render",value:function render(){return e.createElement(l,{context:this.fluxibleContext.getComponentContext()},e.createElement(x,this.props))}}]),FluxifiedSessionSwitchModal}(e.Component)});