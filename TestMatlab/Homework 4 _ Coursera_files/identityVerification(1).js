define("bundles/verification/views/identityVerification",["require","exports","module","underscore","bundles/phoenix/lib/view","bundles/verification/views/identityVerification.html","js/app/config","js/lib/jquery.phoenixWebcam","js/lib/keystrokeAuthenticator","pages/open-course/common/constants","bundles/verification/promises/verification","js/lib/jquery.keytracrecorder","css!bundles/verification/styl/index.css"],function(require,exports,module){"use strict";var _=require("underscore"),i=require("bundles/phoenix/lib/view"),a=require("bundles/verification/views/identityVerification.html"),s=require("js/app/config"),o=require("js/lib/jquery.phoenixWebcam"),n=require("js/lib/keystrokeAuthenticator"),e=require("pages/open-course/common/constants").signatureTrack,t=require("bundles/verification/promises/verification");require("js/lib/jquery.keytracrecorder"),require("css!bundles/verification/styl/index.css");var r=i.extend({stateModelProperty:"model",template:a,events:{'click [data-js~="refetch-verifiable-id"]':"onRefetchVerifiableId",'click [data-js~="skip-identity-verification"]':"onSkipVerifiedSetup",'click [data-js~="cancel-verification-confirm"]':"onCancelVerificationConfirm",'keyup [data-js~="keystroke-auth-input"]':"onEveryKeystroke",'click [data-js~="submit-keystrokes"]':"submitKeystrokes",'click [data-js~="take-photo-button"]':"takePhoto",'click [data-js~="expand-webcam-help"]':"expandWebcamHelp",'click [data-js~="shrink-webcam-help"]':"shrinkWebcamHelp",'click [data-js~="retake-photo"]':"retakePhoto",'click [data-js~="switch-webcam-driver"]':"toggleWebcamDriver",'click [data-js~="submit-photo"]':"onSubmitPhoto",'click [data-js~="complete-verification"]':"onCompleteVerification"},multitracker:{namespace:"verification.identity_verification",baseValues:["course_id","module_id","lesson_id","item_id"],definitions:{course_id:function course_id(){return this.verificationViewModel.metadata.get("course.id")},module_id:function module_id(){return this.verificationViewModel.metadata.get("lesson.module.id")},lesson_id:function lesson_id(){return this.verificationViewModel.metadata.get("lesson.id")},item_id:function item_id(){return this.verificationViewModel.metadata.get("id")},step:function step(){return this.getEventingStep()}},events:{"click.verification_learn_more":{values:["step"],delegate:'click [data-js~="verification-info-link"]'},"click.camera_troubleshoot":'click [data-js~="help-center"]',"click.manual_review_contact_support":'click [data-js~="manual-review-contact-support"]',"click.verification_error_contact_support":'click [data-js~="error-contact-support"]'},eventingVersion:2},webcamOptions:{swfFile:e.swfFile,constraintImgHalf:e.webcamConstraintImage,constraintImgWidthPercent:e.webcamConstraintImageWidthPercent,constraintImgMarginPercent:e.webcamConstraintImageMarginPercent},initialize:function initialize(e){_.bindAll(this,"onEveryKeystroke","checkIfCompletedPhrase","onKeystrokeSubmitSuccess","onKeystrokeSubmitError","onNewWebcamCreated","onCameraEnabled","onCameraDisabled","onSwfApiFail","onWebcamError","onCameraDestroy","onTakePhotoSuccess","onWebcamSubmitSuccess","onWebcamSubmitError"),this.model=e.identityVerificationViewModel,this.verificationViewModel=e.verificationViewModel,this.keystrokeAuthenticator=new n,this.keystrokePhraseLength=this.keystrokeAuthenticator.authPhrase.length,this.initializeEvents(),this.model.fetchVerifiableId()},initializeEvents:function initializeEvents(){this.listenTo(this.model,"change:state",this.onStateChange),this.listenTo(this.model,"state:enter:keystroke-ready",this.onKeystrokeReady),this.listenTo(this.model,"state:enter:keystroke-submitting",this.onKeystrokeSubmitting),this.listenTo(this.model,"state:enter:transitioning-to-webcam",this.onTransitioningToWebcam),this.listenTo(this.model,"state:enter:webcam-ready",this.onWebcamReady),this.listenTo(this.model,"destroy",this.destroy)},destroy:function destroy(){this.destroyKeystrokeRecorder(),this.destroyWebcamInstance(),this.region.close()},postRender:function postRender(){this.track("render")},destroyKeystrokeRecorder:function destroyKeystrokeRecorder(){this.model.get("hasKeytracRecorder")&&(this.$$("keystroke-auth-input").keytracRecorder("removeListener"),this.model.set("hasKeytracRecorder",!1))},destroyWebcamInstance:function destroyWebcamInstance(){this.webcamInstance&&this.webcamInstance.destroy()},onStateChange:function onStateChange(){this.$$("error-messages").hide(),this.$$("skip-verification-block").hide(),this.renderState()},templateOptions:function templateOptions(){return{config:s,keystrokeAuthPhrase:this.keystrokeAuthenticator.authPhrase,canOptOut:this.verificationViewModel.get("canOptOut")}},onRefetchVerifiableId:function onRefetchVerifiableId(){this.model.fetchVerifiableId()},onSkipVerifiedSetup:function onSkipVerifiedSetup(){var e=void 0,t=void 0;this.$$("skip-verification-block").is(":visible")?(e="expanded",t="collapsed"):(e="collapsed",t="expanded"),this.track("click.cancel_verification",{step:this.getEventingStep(),status_before_click:e,status_after_click:t}),this.$$("skip-verification-block").slideToggle()},onCancelVerificationConfirm:function onCancelVerificationConfirm(){this.destroyKeystrokeRecorder(),this.destroyWebcamInstance(),this.$$("cancel-verification-confirm").prop("disabled",!0),this.track("click.cancel_verification_confirm",{step:this.getEventingStep()}),this.verificationViewModel.trigger("verificationComplete",{hasVerified:!1})},getEventingStep:function getEventingStep(){var e="";return this.model.isState("keystroke-ready")||this.model.isState("keystroke-wrong-phrase")?e="typing_pattern":this.model.isState("webcam-ready")?e="take_photo":this.model.isState("webcam-took-photo")&&(e="use_photo"),e},onKeystrokeReady:function onKeystrokeReady(){this.model.get("hasKeytracRecorder")||(this.$$("keystroke-auth-input").keytracRecorder(),this.model.set("hasKeytracRecorder",!0))},onEveryKeystroke:function onEveryKeystroke(){var e=this.$$("keystroke-auth-input").val();this.updateProgressBar(e),this.checkTypedPhraseAndTransition(e)},updateProgressBar:function updateProgressBar(e){var t=e.length,i=Math.min(100,t/this.keystrokePhraseLength*100);this.$$("keystroke-auth-bar").css("width",i+"%")},checkTypedPhraseAndTransition:function checkTypedPhraseAndTransition(e){var t=this.keystrokeAuthenticator.isCorrectAuthPhraseSoFar(e);t?this.model.isState("keystroke-ready")?this.checkIfCompletedPhrase(e):this.model.transition("keystroke-ready"):this.model.isState("keystroke-wrong-phrase")||this.model.transition("keystroke-wrong-phrase")},checkIfCompletedPhrase:function checkIfCompletedPhrase(t){var i=this.keystrokeAuthenticator.isCorrectAuthPhrase(t)&&this.keystrokeAuthenticator.hasCompletedAuthPhrase(t,e.keystroke.errorAllowedPrefix,e.keystroke.errorAllowedSuffix);i?this.$$("submit-keystrokes").prop("disabled",!1):this.$$("submit-keystrokes").prop("disabled",!0)},submitKeystrokes:function submitKeystrokes(){this.$$("submit-keystrokes").prop("disabled",!0),this.$$("keystroke-auth-input").prop("disabled",!0),this.track("click.match_patterns");var i={typeName:"verificationRequest",definition:{requestBody:{golden:this.keystrokeAuthenticator.authPhrase,actual:this.$$("keystroke-auth-input").val(),keystroke:this.$$("keystroke-auth-input").keytracRecorder("keystroke")}}};this.destroyKeystrokeRecorder(),this.model.transition("keystroke-submitting"),_.delay(function(){t(this.verificationViewModel.get("verifiableId"),{data:i}).then(this.onKeystrokeSubmitSuccess,this.onKeystrokeSubmitError).fin(this.onVerificationSubmitComplete).done()}.bind(this),e.verificationSubmitDelay)},onVerificationSubmitComplete:function onVerificationSubmitComplete(){},onKeystrokeSubmitSuccess:function onKeystrokeSubmitSuccess(t){t.get("nextVerificationState")===e.verificationSteps.keystrokes?(this.track("emit.keystroke_next_step_keystroke"),this.$$("keystroke-auth-input").val("").prop("disabled",!1),this.updateProgressBar(""),this.model.transition("keystroke-ready"),this.$$("keystrokes-match-error").slideDown("fast")):t.get("nextVerificationState")===e.verificationSteps.webcam?(this.track("emit.keystroke_next_step_photo"),this.model.transition("transitioning-to-webcam")):t.get("nextVerificationState")===e.verificationSteps.authenticated?(this.track("emit.keystroke_next_step_authenticated"),this.model.transition("keystroke-authenticated")):this.onKeystrokeSubmitError()},onKeystrokeSubmitError:function onKeystrokeSubmitError(){this.track("emit.keystroke_authentication_error"),this.$$("submit-keystrokes").prop("disabled",!1),this.model.transition("keystroke-authenticate-error")},initializeWebcam:function initializeWebcam(e){this.webcamInstance=new o(this.$$("webcam-container"));var t={newWebcamCallback:this.onNewWebcamCreated,cameraEnabledCallback:this.onCameraEnabled,cameraDisabledCallback:this.onCameraDisabled,noCameraFoundCallback:this.onCameraDisabled,swfApiFailCallback:this.onSwfApiFail,error:this.onWebcamError,destroyCameraCallback:this.onCameraDestroy};this.webcamInstance.initialize(_.extend({},this.webcamOptions,t,e))},onTransitioningToWebcam:function onTransitioningToWebcam(){_.delay(function(){this.model.transition("webcam-ready")}.bind(this),e.transitionToWebcamDuration)},onWebcamReady:function onWebcamReady(){this.initializeWebcam()},onNewWebcamCreated:function onNewWebcamCreated(){this.webcamInstance.isHTML5Supported()?(this.$$("html5-webcam-help-image").attr("src",this.getHTML5WebcamHelpImage()),this.$$("switch-to-html5-webcam-link").show()):this.$$("switch-to-html5-webcam-link").hide(),this.webcamInstance.isUsingHTML5()?(this.$$("html5-webcam-allow-text").show(),this.$$("flash-webcam-allow-text").hide(),this.$$("html5-webcam-help-image-container").show(),navigator.mozGetUserMedia?(this.$$("moz-webcam-help-text").show(),this.$$("chrome-webcam-help-text").hide()):(this.$$("moz-webcam-help-text").hide(),this.$$("chrome-webcam-help-text").show())):(this.$$("flash-webcam-allow-text").show(),this.$$("html5-webcam-allow-text").hide(),this.$$("html5-webcam-help-image-container").hide())},onCameraEnabled:function onCameraEnabled(){this.track("emit.camera_enabled"),this.$$("html5-webcam-allow-text").hide(),this.$$("flash-webcam-allow-text").hide(),this.$$("take-photo-button").prop("disabled",!1),this.shrinkWebcamHelp()},onCameraDisabled:function onCameraDisabled(){this.$$("take-photo-button").prop("disabled",!0)},onSwfApiFail:function onSwfApiFail(){this.onWebcamError("Flash webcam error: swf API failure.")},onWebcamError:function onWebcamError(e){this.$$("error-messages").hide(),this.$$("webcam-error").val(e),this.$$("webcam-error").slideDown("fast")},onCameraDestroy:function onCameraDestroy(){this.$$("take-photo-button").prop("disabled",!0)},toggleWebcamDriver:function toggleWebcamDriver(){this.webcamInstance.isHTML5Supported()&&(this.shrinkWebcamHelp(),this.webcamInstance.isUsingHTML5()?this.track("click.switch_to_flash"):this.track("click.switch_to_html5"),this.webcamInstance.toggleDriver())},expandWebcamHelp:function expandWebcamHelp(){this.track("click.help_camera",{status_before_click:"collapsed",status_after_click:"expanded"}),this.$$("expand-webcam-help").attr("data-js","shrink-webcam-help"),this.webcamInstance.isUsingHTML5()?this.$$("webcam-help-instructions-html5").slideDown():this.$$("webcam-help-instructions-flash").slideDown()},shrinkWebcamHelp:function shrinkWebcamHelp(){this.track("click.help_camera",{status_before_click:"expanded",status_after_click:"collapsed"}),this.$$("shrink-webcam-help").attr("data-js","expand-webcam-help"),this.$$("webcam-help-instructions-html5").slideUp(),this.$$("webcam-help-instructions-flash").slideUp()},getHTML5WebcamHelpImage:function getHTML5WebcamHelpImage(){return navigator.mozGetUserMedia?e.firefoxWebcamHelpImage:e.chromeWebcamHelpImage},takePhoto:function takePhoto(e){e.preventDefault(),this.shrinkWebcamHelp(),this.track("click.take_photo"),this.webcamInstance.takePhoto(this.onTakePhotoSuccess)},onTakePhotoSuccess:function onTakePhotoSuccess(e){this.track("emit.photo_taken"),this.imageData=e,this.model.transition("webcam-took-photo"),this.$$("take-photo-button").prop("disabled",!0),this.$$("submit-photo").prop("disabled",!1)},retakePhoto:function retakePhoto(){this.destroyWebcamInstance(),this.track("click.retake_photo"),this.model.transition("webcam-ready")},onSubmitPhoto:function onSubmitPhoto(){this.$$("submit-photo").prop("disabled",!0),this.track("click.use_photo");var i={typeName:"verificationRequest",definition:{requestBody:{photoToReviewUri:this.imageData}}};this.model.transition("webcam-submitting"),_.delay(function(){t(this.verificationViewModel.get("verifiableId"),{data:i}).then(this.onWebcamSubmitSuccess,this.onWebcamSubmitError).fin(this.onVerificationSubmitComplete).done()}.bind(this),e.verificationSubmitDelay)},onWebcamSubmitSuccess:function onWebcamSubmitSuccess(t){t.get("nextVerificationState")===e.verificationSteps.webcam?(this.destroyWebcamInstance(),this.track("emit.photo_next_step_photo"),this.model.transition("webcam-ready"),this.$$("webcam-submit-error").slideDown("fast")):t.get("nextVerificationState")===e.verificationSteps.webcamManual?(this.track("emit.photo_next_step_manual"),this.model.transition("webcam-not-authenticated")):t.get("nextVerificationState")===e.verificationSteps.authenticated?(this.destroyWebcamInstance(),this.track("emit.photo_next_step_authenticated"),this.model.transition("webcam-authenticated")):this.onWebcamSubmitError()},onWebcamSubmitError:function onWebcamSubmitError(){this.track("emit.photo_authentication_error"),this.$$("submit-photo").prop("disabled",!1),this.model.transition("webcam-authenticate-error")},onCompleteVerification:function onCompleteVerification(){this.$$("complete-verification").prop("disabled",!0),this.model.isState("webcam-not-authenticated")?this.track("click.manual_review_verification_complete"):this.track("click.verification_complete"),this.verificationViewModel.trigger("verificationComplete",{hasVerified:!0})}});module.exports=r});