define("bundles/scribe-plugins/scribe-plugin-code-command",["require","exports","module","jquery","underscore","react-with-addons","react-dom","lazy!bundles/phoenix/models/AceEditor","bundles/scribe-plugins/scribe-plugin-code-command/models/CodeIndexer","bundles/scribe-plugins/scribe-plugin-code-command/models/CodeLanguageLocalStorage","bundles/scribe-plugins/scribe-plugin-code-command/components/ScribeCodeEditor","bundles/scribe-plugins/scribe-utils"],function(require,exports,module){"use strict";var $=require("jquery"),_=require("underscore"),r=require("react-with-addons"),o=require("react-dom"),i=require("lazy!bundles/phoenix/models/AceEditor"),a=require("bundles/scribe-plugins/scribe-plugin-code-command/models/CodeIndexer"),e=require("bundles/scribe-plugins/scribe-plugin-code-command/models/CodeLanguageLocalStorage"),d=require("bundles/scribe-plugins/scribe-plugin-code-command/components/ScribeCodeEditor"),n=require("bundles/scribe-plugins/scribe-utils"),c=n.findBlockContainer,u=n.isEmptyParagraphBlock,t="scribe-plugin-code-command";module.exports=function(n){return function(l){var p=null,g=new l.api.SimpleCommand("code","CODE"),s=new a(l),b=function handleBlockRemove(e){l.transactionManager.run(function(){return s.getCodeElementAtIndex(e).remove()})},f=function handleBlockLanguageChange(t,n){var r=s.getAceEditorAtIndex(t),o=s.getCodeElementAtIndex(t);r.setLanguage(n),l.transactionManager.run(function(){return o.setAttribute("data-language",n)}),e.set(n)},C=function positionAndSizeEditor(t,e){var r=e.offsetTop,o=e.offsetLeft,i=e.offsetWidth,n=t.el.parentNode;n.style.position="absolute",n.style.top=r+2+"px",n.style.left=o+2+"px",n.style.width=i-2+"px";var a=t.resizeHeight();$(e).height(a)},E=function renderAceEditor(u,c){var E=c.innerText,g=e.get(),i=c.getAttribute("data-language");!i&&g&&(i=g,c.setAttribute("data-language",i));var a=document.createElement("div");a.style.position="relative",a.setAttribute("class",t),o.render(r.createElement(d,{languageValue:i,onRemove:function(){return b(u)},onLanguageChange:function(e){return f(u,e)}}),a);var m=document.createElement("div");a.appendChild(m),n.appendChild(a);var C=new p({el:m,value:E,language:i,onChange:function onChange(e){return l.transactionManager.run(function(){return s.getCodeElementAtIndex(u).innerText=e})},onFocus:function onFocus(e){return l.trigger("content-changed")}});return c===s.focusedCodeElement&&setTimeout(function(){return C.editor.focus()},0),C},h=function removeAceEditors(){$("."+t,n).remove(),s.clearAceEditorCache()},m=function update(n){if(!p)return!1;var e=s.getAllCodeElements();e.length!==_(s.aceEditors).values().length&&h(),e.map(function(n,t){var e=s.getAceEditorAtIndex(n);e||(e=E(n,t),s.setAceEditorAtIndex(e,n)),C(e,t)})};g.execute=function(){l.transactionManager.run(function(){var r=new l.api.Selection,t=r.range;if(!t)return!1;var n=document.createElement("pre"),e=c(l,t.endContainer);u(l,e)?(e.nextSibling||e.parentNode.appendChild(document.createElement("p")),e.parentNode.replaceChild(n,e)):e.nextSibling?e.parentNode.insertBefore(n,e.nextSibling):(e.parentNode.appendChild(n),e.parentNode.appendChild(document.createElement("p"))),s.setFocusOnCodeElement(n)})},g.queryEnabled=function(){var e=new l.api.Selection,n=e.range;if(!n)return!1;return!0},g.queryState=function(){},i(function(e){p=e,m()}),l.on("content-changed",m),l.el.addEventListener("keydown",m),l.commands.code=g}}});