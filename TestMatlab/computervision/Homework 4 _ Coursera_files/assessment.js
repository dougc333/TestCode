define("bundles/assess/assessmentTypes/phoenixQuiz/assessment",["require","exports","module","jquery","moment","underscore","bundles/assess/assessmentTypes/phoenixQuiz/assessment.exam.html","bundles/assess/assessmentTypes/phoenixQuiz/assessment.quiz.html","bundles/ondemand/appContextSingleton","bundles/ondemand/components/LockingCover","bundles/ondemand/components/assignments/AssignmentHonorCode","bundles/ondemand/utils/assignmentVerificationTest","bundles/page/lib/metatagsAddressBook","bundles/phoenix/components/TimeDuration","bundles/phoenix/lib/view","bundles/phoenix/template/models/userAuthorization","bundles/phoenix/template/models/userIdentity","bundles/assess/components/NumberOfAttempts","bundles/ondemand/utils/deadlineFormatter","js/lib/modals","js/lib/pluralize","pages/open-course/assessment/models/relativePassingStates","pages/open-course/common/utils/ensureEnrolled","pages/open-course/common/views/performanceBar","js/lib/tooltips"],function(require,exports,module){"use strict";var $=require("jquery"),i=require("moment"),_=require("underscore"),u=require("bundles/assess/assessmentTypes/phoenixQuiz/assessment.exam.html"),g=require("bundles/assess/assessmentTypes/phoenixQuiz/assessment.quiz.html"),t=require("bundles/ondemand/appContextSingleton"),p=require("bundles/ondemand/components/LockingCover"),n=require("bundles/ondemand/components/assignments/AssignmentHonorCode"),v=require("bundles/ondemand/utils/assignmentVerificationTest"),x=v.inHonorCodeVariant,l=require("bundles/page/lib/metatagsAddressBook"),s=require("bundles/phoenix/components/TimeDuration"),r=require("bundles/phoenix/lib/view"),C=require("bundles/phoenix/template/models/userAuthorization"),h=require("bundles/phoenix/template/models/userIdentity"),c=require("bundles/assess/components/NumberOfAttempts"),o=require("bundles/ondemand/utils/deadlineFormatter"),a=require("js/lib/modals"),b=require("js/lib/pluralize"),f=require("pages/open-course/assessment/models/relativePassingStates"),d=require("pages/open-course/common/utils/ensureEnrolled"),S=require("pages/open-course/common/views/performanceBar");require("js/lib/tooltips");var e=function getMetadata(e){return function(){return this.model.get("metadata").get(e)}},m=r.extend({name:"itemView",bodyClasses:"c-item-assessment",multitracker:{namespace:"open_course.item_page.quiz",baseValues:["open_course_slug","module_id","module_name","lesson_id","lesson_name","item_id","item_name"],definitions:{open_course_slug:e("course.slug"),module_id:e("lesson.module.id"),module_name:e("lesson.module.name"),lesson_id:e("lesson.id"),lesson_name:e("lesson.name"),item_id:e("id"),item_name:e("name")},events:{start:[],resume:[]},eventingVersion:2},events:{'click [data-js~="start-button"]':"start",'click [data-js~="retake-button"]':"start",'click [data-js~="review-button"]':"review",'click [data-js~="confirm-start-button"]':"confirmedStart",'click [data-js~="stay-button"]':"closeModal"},initialize:function initialize(e){$("body").addClass(this.bodyClasses),_.bindAll(this,"confirmedStart"),this.onStateChange=e.onStateChange,this.verificationDisplay=e.verificationDisplay,this.itemGrade=e.itemGrade,this.courseSlug=this.model.get("metadata.course.slug"),this.moduleNumber=this.model.get("metadata.lesson.module.index"),this.authenticated=h.get("authenticated"),this.isVerificationEnabled=this.model.get("metadata.course").isVerificationEnabled(),this.initializePerformanceBar(),this.on("view:closing",this.onClose,this),l.setMetatags({pageName:"title-and-description",context:{title:this.model.get("metadata.name"),description:this.model.get("metadata.lesson.module.description")},options:{imageHref:this.model.get("metadata.course.promoPhoto")}})},initializePerformanceBar:function initializePerformanceBar(){var e=this.model.getDisplayEvaluation(this.verificationDisplay);this.authenticated&&e&&(this.performanceBar=new S({evaluation:e,showValue:!1,disableTransitions:!0}))},onClose:function onClose(){$("body").removeClass(this.bodyClasses)},closeModal:function closeModal(){if(!this.modal)return;this.modal.close(),this.modal=null},startQuiz:function startQuiz(){if("exam"===this.model.get("metadata").getTypeName()&&this.model.isLastAttemptBeforeLock()){this.closeModal();var e=t.getComponentContext(),s=e.getStore("SessionStore");s.isSessionsEnabled()?this.modal=a(this.$$("last-attempt-session-modal")):this.modal=a(this.$$("last-attempt-ondemand-modal")),this.modal.open()}else this.confirmedStart()},start:function start(){if(!C.ensureAuthenticated())return null;d().then(this.startQuiz.bind(this)).fail(function(e){if(!(e instanceof d.UserRejectedEnrollPromptException))throw e}).done()},confirmedStart:function confirmedStart(){this.closeModal(),this.model.hasUnsubmittedAttempt()?this.track("resume"):this.track("start");var e=this.model.get("metadata"),t=e.isPremiumGradingLocked();if("exam"===e.getTypeName()&&this.verificationDisplay.get("isProductVerificationEnabled")&&!t){var s=this.model.get("metadata.id");this.showHonorCode=x()&&!n.hasAcceptedHonorCode(s),this.showHonorCode?this.render():this.openVerificationModule()}else this.onStateChange("attempt")},openVerificationModule:function openVerificationModule(){this.onStateChange("verify")},review:function review(){this.onStateChange("attempt",{attemptIndex:this.model.getLastSubmittedAttempt()})},render:function render(){var a=g;"exam"===this.model.get("metadata").getTypeName()&&(a=u);var l=this.model.getDisplayEvaluation(this.verificationDisplay),m=this.model.getRelativePassingState(this.verificationDisplay),s={model:this.model,pluralize:b,moment:i,authenticated:this.authenticated,evaluation:l,relativePassingState:m,relativePassingStates:f,showHonorCode:this.showHonorCode},n=t.getComponentContext(),e=n.getStore("SessionStore");if(e.isEnrolled()){var r=this.model.get("metadata.lesson.module.id"),h=n.getStore("CourseScheduleStore"),d=h.getDeadlineForModuleId(r),c=this.model.get("bestEvaluation")&&this.model.get("bestEvaluation").getHumanPercentScore(),p=this.model.get("bestSessionId")?new Date(parseInt(this.model.get("bestSessionId").split("~")[1],10)):null;_(s).extend({enrolledInSession:!0,deadline:o.getFormattedDeadline(d),hasDeadlinePassed:i().isAfter(d),courseDeadline:o.getFormattedDeadline(e.getEndDate()),bestScore:c})}return this.$el.html(a(s)),this.renderSubviews(),this.renderRetakeButton(),this.authenticated&&this.model.hasSubmittedAttempt()&&this.model.examIsLocked&&this.model.examIsLocked()&&this.track("time_lock.render"),this},renderSubviews:function renderSubviews(){if(this.showHonorCode&&this.renderReactInto(n,"AssignmentHonorCode",{onHonorCodeAccept:this.openVerificationModule.bind(this),itemId:this.model.get("metadata.id")}),this.performanceBar&&this.$$("performance-bar-container").html(this.performanceBar.render().el),this.model.get("metadata").isLocked()&&this.renderReactInto(p,"LockingCover",{itemMetadata:this.model.get("metadata")},t.getComponentContext()),"exam"===this.model.get("metadata").getTypeName()){var e=this.model.get("metadata").getDefinition("lockingConfiguration"),a=1===e.allowedSubmissionsPerInterval,i=e.allowedSubmissionsInterval,d=this.model.get("locksIfSubmittedBefore")-Date.now(),o=a?i:d;this.renderReactIntoAll(s,"ShortIntervalDisplay",{duration:i,showNumberIfSingular:!1},void 0,!0),this.renderReactIntoAll(s,"RemainingIntervalDisplay",{duration:o,showNumberIfSingular:!1},void 0,!0),this.renderReactIntoAll(s,"RemainingIntervalFullDisplay",{duration:o,showNumberIfSingular:!0},void 0,!0);var l=e.allowedSubmissionsPerInterval;this.renderReactIntoAll(c,"NumberOfAttempts",{numberOfAttempts:l},void 0,!0)}},renderRetakeButton:function renderRetakeButton(){"exam"===this.model.get("metadata").getTypeName()&&this.$$("retake-button").attr("disabled",this.model.examIsLocked())}});module.exports=m});