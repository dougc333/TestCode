define("bundles/content-feedback/components/flag/GradingProblemFeedbackEditor",["require","exports","module","classnames","react-with-addons","./../FeedbackEditor","bundles/content-feedback/actions/ProgrammingGradingProblemsActions","bundles/phoenix/utils/CMLUtils","i18n!nls/content-feedback","vendor/cnpm/fluxible.v0-4/addons/connectToStores","css!./__styles__/GradingProblemFeedbackEditor"],function(require,exports,module){"use strict";function _defaults(e,a){for(var i=Object.getOwnPropertyNames(a),t=0;t<i.length;t++){var r=i[t],n=Object.getOwnPropertyDescriptor(a,r);n&&n.configurable&&void 0===e[r]&&Object.defineProperty(e,r,n)}return e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):_defaults(t,e))}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function defineProperties(n,r){for(var t=0;t<r.length;t++){var e=r[t];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(n,e.key,e)}}return function(e,t,r){return t&&defineProperties(e.prototype,t),r&&defineProperties(e,r),e}}(),o=function get(i,c,d){var r=!0;e:for(;r;){var t=i,s=c,o=d;r=!1,null===t&&(t=Function.prototype);var e=Object.getOwnPropertyDescriptor(t,s);if(void 0===e){var n=Object.getPrototypeOf(t);if(null===n)return void 0;i=n,c=s,d=o,r=!0,e=n=void 0;continue e}if("value"in e)return e.value;var a=e.get;if(void 0===a)return void 0;return a.call(o)}},c=require("classnames"),e=require("react-with-addons"),s=require("./../FeedbackEditor"),n=require("bundles/content-feedback/actions/ProgrammingGradingProblemsActions"),t=require("bundles/phoenix/utils/CMLUtils"),r=require("i18n!nls/content-feedback"),d=require("vendor/cnpm/fluxible.v0-4/addons/connectToStores");require("css!./__styles__/GradingProblemFeedbackEditor");var l=n.loadProgrammingSubmittedParts,u=n.loadProgrammingPartGradingFeedbacks,p=n.saveProgrammingPartGradingFeedbacks,a=function PartState(e,r,n){_classCallCheck(this,PartState),this.id=e,this.isChecked=r||!1,this.cml=n||t.create("")},m=function(n){function GradingProblemFeedbackEditor(r,n){var e=this;_classCallCheck(this,GradingProblemFeedbackEditor),o(Object.getPrototypeOf(GradingProblemFeedbackEditor.prototype),"constructor",this).call(this,r,n),this.handleCheck=function(r,i){e.state.partStates[r.id]||(e.state.partStates[r.id]=new a(r.id));var n=e.state.partStates[r.id];n.isChecked=i.target.checked,n.cml=i.target.checked?n.cml:t.create(""),e.forceUpdate()},this.handleSend=function(t){t.preventDefault(),e.context.executeAction(p,{courseId:e.props.itemMetadata.get("course.id"),itemId:e.props.itemMetadata.get("id"),parts:e.props.submittedParts.map(function(t){return{id:t.id,submissionId:t.submissionId,content:e.state.partStates[t.id].cml}})}),e.setState({partStates:null}),e.props.onSend()},this.handleChange=function(t,r){e.state.partStates[t.id]||(e.state.partStates[t.id]=new a(t.id)),e.state.partStates[t.id].cml=r,e.forceUpdate()},this.handleCancel=function(t){t.preventDefault(),e.initializePartStates(e.props.submittedParts,e.props.feedbacks),e.props.onCancel()},this.context.executeAction(l,{itemMetadata:r.itemMetadata}),this.state={loading:!0,partStates:null}}return _inherits(GradingProblemFeedbackEditor,n),i(GradingProblemFeedbackEditor,null,[{key:"propTypes",value:{itemMetadata:e.PropTypes.object.isRequired,isFocused:e.PropTypes.bool,placeholder:e.PropTypes.string.isRequired,onCancel:e.PropTypes.func.isRequired,onRemove:e.PropTypes.func.isRequired,onSend:e.PropTypes.func.isRequired,submittedParts:e.PropTypes.arrayOf(e.PropTypes.shape({id:e.PropTypes.string.isRequired,label:e.PropTypes.string.isRequired,submissionId:e.PropTypes.string.isRequired})),feedbacks:e.PropTypes.object},enumerable:!0},{key:"contextTypes",value:{executeAction:e.PropTypes.func.isRequired},enumerable:!0}]),i(GradingProblemFeedbackEditor,[{key:"componentWillReceiveProps",value:function componentWillReceiveProps(e){this.state.loading&&e.submittedParts&&(this.context.executeAction(u,{courseId:this.props.itemMetadata.get("course.id"),itemId:this.props.itemMetadata.get("id"),parts:e.submittedParts}),e.feedbacks&&(this.initializePartStates(e.submittedParts,e.feedbacks),this.setState({loading:!1})))}},{key:"initializePartStates",value:function initializePartStates(r,n){var e={};r.forEach(function(r){var i=n[r.id],s=i&&i.comments?i.comments:{},o=s.grading||s.content||t.create("");e[r.id]=new a(r.id,!t.isEmpty(o),o)}),this.setState({partStates:e})}},{key:"isLoaded",value:function isLoaded(){return this.props.submittedParts&&this.state.partStates&&this.props.feedbacks}},{key:"areAnyPartsChecked",value:function areAnyPartsChecked(){var e=this;return this.props.submittedParts.some(function(r){var t=e.state.partStates[r.id];return t&&t.isChecked})}},{key:"areAllCheckedPartsFilled",value:function areAllCheckedPartsFilled(){var e=this;return this.props.submittedParts.every(function(n){var r=e.state.partStates[n.id];return r&&(!r.isChecked||!t.isEmpty(r.cml))})}},{key:"allowSend",value:function allowSend(){var e=this;if(!this.isLoaded())return!1;return this.props.submittedParts.some(function(n){var r=e.props.feedbacks[n.id],a=e.state.partStates[n.id],i=r&&r.comments?r.comments:{},s=i.grading||i.content||t.create("");return a&&t.getInnerText(s)!==t.getInnerText(a.cml)})}},{key:"renderContent",value:function renderContent(){var t=this,n=this.props,a=n.submittedParts,i=n.isFocused;if(!this.isLoaded())return e.createElement("div",null,e.createElement("p",null,r("Loading...")));if(0===a.length)return e.createElement("div",null,e.createElement("p",null,r("You must submit the assignment before providing feedback on specific parts.")));var o=c("flag-action",{disabled:!this.allowSend()});return e.createElement("div",null,e.createElement("p",null,r("Which parts would you like to report?")),e.createElement("ul",{className:"part-list"},a.map(function(r,o){var n=t.state.partStates[r.id],c=n&&n.cml,a=n&&n.isChecked;return e.createElement("li",null,e.createElement("label",null,e.createElement("input",{type:"checkbox",checked:a,onChange:t.handleCheck.bind(t,r)}),r.label),a&&e.createElement(s,{cml:c,onChange:t.handleChange.bind(t,r),isFocused:i&&0===o,placeholder:"Describe problem"}))})),e.createElement("hr",{className:"flag-actions-divider"}),e.createElement("div",{className:"flag-actions"},e.createElement("a",{href:"#",className:o,onClick:this.handleSend},r("Send")),e.createElement("a",{href:"#",className:"flag-action",onClick:this.handleCancel},r(this.state.flagExists?"Remove":"Cancel"))))}},{key:"render",value:function render(){return e.createElement("div",{className:"rc-GradingProblemFeedbackEditor c-flag-editor"},this.renderContent())}}]),GradingProblemFeedbackEditor}(e.Component);module.exports=d(m,["ProgrammingGradingProblemsStore"],function(t,r){var e=t.ProgrammingGradingProblemsStore;return{submittedParts:e.getSubmittedParts(),feedbacks:e.getFeedbacks()}})});